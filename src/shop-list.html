<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/google-map/google-map-marker.html">

<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">

<link rel="import" href="shared-styles.html">

<dom-module id="shop-list">
    <template>
        <style>
            google-map {
                height: 200px;
            }

            #mapDialog {
                width: 96%;
            }

            /*#mapDialog {
                width: 96%;
            }
            #mapDialog google-map{
                height: 400px;
                width: 80%;
            }*/

            app-toolbar {
                background: rgb(51, 245, 252);
            }

            .with-margin {
                --paper-card: {
                    margin: 1% 20%;
                    width: 60%;
                }
            }

            .shop-image {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                width: 50%;
                height: 100%;
                /* background: url('../images/pyaterochka.png'); */
                background-size: cover;
            }

            .shop-name {
                padding-left: 1%;
                @apply --paper-font-headline;
            }

            .shop-description {
                padding-left: 3%;
                color: var(--paper-grey-600);
                margin: 10px 0;
            }

            .shop-icon {
                width: 48px;
                height: 48px;
            }

            .shop-location-img {
                padding-left: 1%;
                color: var(--paper-grey-600);
            }

            .shop-coordinates {
                color: black;
            }

            .actions {
                float: right;
            }
        </style>
        <app-header reveals>
            <app-toolbar>
                <div main-title>Магазины</div>
                <paper-icon-button icon="search"></paper-icon-button>
                <paper-icon-button icon="add" on-click="openInsertShopDialog"></paper-icon-button>
            </app-toolbar>
        </app-header>
        <h1> Hello [[nameShop]]</h1>
        <google-map fit-to-markers api-key="AIzaSyDFsX7B97xHnLZWGD97X6ZGV8H9ZKBiJek" latitude="53.195538" longitude="50.101783">
                <google-map-marker latitude="{{latitude}}" longitude="{{longitude}}" draggable="true"></google-map-marker>
            </google-map>
        <!-- <google-map fit-to-markers api-key="[[apiKey]]" latitude="53.195538" longitude="50.101783">
            <google-map-marker latitude="{{latitude}}" longitude="{{longitude}}" draggable="true"></google-map-marker>
        </google-map>
        <label  id="label2">Выберите иконку:</label>
        <paper-radio-group selected="pyaterochka" aria-labelledby="label2">
            <paper-radio-button name="pyaterochka"> <iron-image src="/images/pyaterochka.png"/></paper-radio-button>
            <paper-radio-button name="perekrestok"> <iron-image src="/images/perekrestok.png"/></paper-radio-button>
            <paper-radio-button name="lenta"><iron-image src="/images/lenta.png"/></paper-radio-button>
            <paper-radio-button name="magnit"><iron-image src="/images/magnit.png"/></paper-radio-button>
            <paper-radio-button name="karusel"><iron-image src="/images/karusel.png"/></paper-radio-button>
            <paper-radio-button name="auchan"><iron-image src="/images/auchan.png"/> </paper-radio-button>
        </paper-radio-group>

        <paper-input bind-value="{{nameShop}}" value="{{nameShop}}" placeholder="Наименование"></paper-input>
        <paper-input id="input" bind-value="{{descriptionShop}}" value="{{descriptionShop}}" placeholder="Описание"></paper-input> -->

        <paper-input id="input" value="{{searchString}}" placeholder="Строка"></paper-input>
        <button on-click="filter">Filter</button>
        <button on-click="getAllShops">Get data</button>
        <button on-click="addShop">Add data</button>
        <!-- <google-map fit-to-markers api-key="[[apiKey]]" latitude="53.195538" longitude="50.101783">
            <template is="dom-repeat" items="{{markers}}">
                <google-map-marker  slot="markers" latitude="{{item.latitude}}" longitude="{{item.longitude}}"> </google-map-marker>
            </template>
        </google-map> -->

        <paper-dialog id="mapDialog">
            <paper-dialog-scrollable>
                <google-map slot="markers" fit-to-markers api-key="[[apiKey]]" latitude="{{latitude}}" longitude="{{longitude}}">
                    <google-map-marker slot="markers" latitude="{{latitude}}" longitude="{{longitude}}" draggable="true"></google-map-marker>
                </google-map>
                <!-- <google-map  slot="markers" fit-to-markers api-key="[[apiKey]]" latitude="[[latitude]]" longitude="[[item.longitude]]">
                <google-map-marker  slot="markers" latitude="[[latitude]]" longitude="[[item.longitude]]"> </google-map-marker>
            </google-map> -->
            </paper-dialog-scrollable>
            <div class='buttons'>
                <paper-button dialog-dismiss>Закрыть</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="insertShopDialog">
            <paper-dialog-scrollable>
                <!-- <google-map slot="markers" fit-to-markers api-key="[[apiKey]]" latitude="53.195538" longitude="50.101783">
                <google-map-marker  slot="markers" latitude="{{latitude}}" longitude="{{longitude}}" draggable="true"></google-map-marker>
            </google-map> -->
                <google-map fit-to-markers api-key="[[apiKey]]" latitude="53.195538" longitude="50.101783">
                    <google-map-marker latitude="{{latitude}}" longitude="{{longitude}}" draggable="true"></google-map-marker>
                </google-map>
                <label id="label2">Выберите иконку:</label>
                <paper-radio-group selected="{{iconShop}}" aria-labelledby="label2">
                    <paper-radio-button name="pyaterochka">
                        <iron-image src="/images/pyaterochka.png" />
                    </paper-radio-button>
                    <paper-radio-button name="perekrestok">
                        <iron-image src="/images/perekrestok.png" />
                    </paper-radio-button>
                    <paper-radio-button name="lenta">
                        <iron-image src="/images/lenta.png" />
                    </paper-radio-button>
                    <paper-radio-button name="magnit">
                        <iron-image src="/images/magnit.png" />
                    </paper-radio-button>
                    <paper-radio-button name="karusel">
                        <iron-image src="/images/karusel.png" />
                    </paper-radio-button>
                    <paper-radio-button name="auchan">
                        <iron-image src="/images/auchan.png" /> </paper-radio-button>
                </paper-radio-group>

                <paper-input bind-value="{{nameShop}}" value="{{nameShop}}" placeholder="Наименование"></paper-input>
                <paper-input id="input" bind-value="{{descriptionShop}}" value="{{descriptionShop}}" placeholder="Описание"></paper-input>
            </paper-dialog-scrollable>
            <div class='buttons'>
                <paper-button dialog-dismiss>Отмена</paper-button>
                <paper-button id="{{idShop}}" on-click="doAction">Сохранить</paper-button>
            </div>
        </paper-dialog>

        <template is="dom-repeat" items="{{shops}}" id="shopList">
            <paper-card class="with-margin">
                <div class="card-content">
                    <div class="shop-name">
                        <iron-icon class="shop-icon" src="/images/[[item.icon]].png"></iron-icon> {{item.name}}</div>
                    <div class="shop-description">{{item.description}}</div>
                    <!-- <div>
                        <paper-icon-button slot="top" icon="maps:place"> {{item.latitude}}, {{item.longitude}}</paper-icon-button>
                    </div> -->
                    <div class="horizontal justified shop-location-img ">
                        <paper-icon-button slot="top" icon="maps:place" on-click='openMapDialog'></paper-icon-button>
                        <span class="shop-coordinates">[[item.latitude]], [[item.longitude]]</span>
                    </div>

                </div>
                <div class="card-actions">
                    <paper-button class="actions" on-click="delete">Удалить</paper-button>
                    <paper-button class="actions" on-click="openUpdateShopDialog">Изменить</paper-button>
                </div>
            </paper-card>
        </template>
        <!-- <template is="dom-repeat" items="{{shops}}" id="shopList">
            <div>Name:
                <span>{{item.name}}</span>
            </div>
            <div>Description:
                <span>{{item.description}}</span>
            </div>
            <button on-click="delete">x</button>
            <button on-click="update">update</button>
        </template> -->
    </template>
    <script>
        Polymer({
            is: "shop-list",
            properties: {
                apiKey: {
                    type: String,
                    value: function () {
                        return "AIzaSyDFsX7B97xHnLZWGD97X6ZGV8H9ZKBiJek";
                    }
                },
                idShop: {
                    type: Number
                },
                nameShop: {
                    type: String
                },
                descriptionShop: {
                    type: String
                },
                iconShop: {
                    type: String,
                    value: "pyaterochka"
                },
                shops: {
                    type: Array,
                    value: []
                },
                markers: {
                    type: Array,
                    value: []
                },
                searchString: {
                    type: String
                },
                longitude: {
                    type: Number,
                    value: 50.101783
                },
                latitude: {
                    type: Number,
                    value: 53.195538
                },
                action: {
                    type: String
                }
            },
            indexedDB: window.indexedDB || window.webkitIndexedDB ||
                window.mozIndexedDB || window.msIndexedDB,
            IDBTransaction: window.IDBTransaction || window.webkitIDBTransaction,
            db: null,
            ready: function () {
                this.initDb();
                this.getAllShops();
            },
            initDb: function () {
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    this.db = request.result;
                };
                request.onerror = function (evt) {
                    console.log("IndexedDB error: " + evt.target.errorCode);
                };
                request.onupgradeneeded = function (evt) {
                    var objectStore = evt.currentTarget.result.createObjectStore("shop", {
                        keyPath: "id",
                        autoIncrement: true
                    });
                    objectStore.createIndex("name", "name");
                    objectStore.createIndex("coordinates", ["longitude", "latitude"]);

                    var objectStore = evt.currentTarget.result.createObjectStore("productList", {
                        keyPath: "id",
                        autoIncrement: true
                    });
                    objectStore.createIndex("date_shop", ["date", "idShop"]);
                };
            },
            addShop: function () {
                var description = this.descriptionShop;
                var name = this.nameShop;
                var db;
                var longitude = this.longitude;
                var latitude = this.latitude;
                var icon = this.iconShop;
                var self = this;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");
                    objectStore.add({
                        name: name,
                        description: description,
                        longitude: longitude,
                        latitude: latitude,
                        icon: icon
                    });
                    self.getAllShops();
                }
                this.$.insertShopDialog.close();
            },
            getData: function () {
                var name = this.nameShop;
                var db;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");
                    var index = objectStore.index("name");
                    var getBob = index.get(name);

                    getBob.onsuccess = function () {
                        this.descriptionShop = "111";
                        console.log(this.descriptionShop);
                    };
                };
            },
            getAllShops: function () {
                this.shops = [];
                var db;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                var self = this;

                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");
                    var cursors = objectStore.openCursor();
                    cursors.onsuccess = function (event) {
                        if (event.target.result) {
                            self.push('shops', {
                                id: event.target.result.value["id"],
                                name: event.target.result.value["name"],
                                description: event.target.result.value["description"],
                                latitude: event.target.result.value["latitude"],
                                longitude: event.target.result.value["longitude"],
                                icon: event.target.result.value["icon"]
                            });
                            self.push('markers', {
                                latitude: event.target.result.value["latitude"],
                                longitude: event.target.result.value["longitude"]
                            });
                            event.target.result['continue']();
                        }
                    };
                    console.log(self.markers);
                };
            },
            delete: function (e) {
                var item = this.$.shopList.itemForElement(e.target);
                var description = this.descriptionShop;
                var name = this.nameShop;
                var db;
                var self = this;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");
                    objectStore.delete(item.id);
                    self.getAllShops();
                }
            },
            update: function (e) {
                // var item = this.$.shopList.itemForElement(e.target);
                var description = this.descriptionShop;
                var name = this.nameShop;
                var longitude = this.longitude;
                var latitude = this.latitude;
                var icon = this.iconShop;
                var id = this.idShop;
                var db;
                var self = this;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");

                    /* item.name = self.nameShop;
                     item.description = self.descriptionShop;*/
                    // objectStore.put(item,);
                    objectStore.put({
                        id: id,
                        name: name,
                        description: description,
                        longitude: longitude,
                        latitude: latitude,
                        icon: icon
                    });
                    self.getAllShops();
                }
                this.$.insertShopDialog.close();
            },
            filter: function () {
                this.shops = [];
                var db;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                var self = this;

                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readonly');
                    var objectStore = transaction.objectStore("shop");
                    var index = objectStore.index("name");
                    if (self.searchString == null) {
                        var cursors = objectStore.openCursor();
                        cursors.onsuccess = function (event) {
                            if (event.target.result) {
                                self.push('shops', {
                                    id: event.target.result.value["id"],
                                    name: event.target.result.value["name"],
                                    description: event.target.result.value["description"]
                                });
                                event.target.result['continue']();
                            }
                        };
                    } else {
                        var cursors = index.openCursor(IDBKeyRange.bound(self.searchString, self.searchString +
                            '\uffff', true, true));
                        cursors.onsuccess = function (event) {
                            if (event.target.result) {
                                self.push('shops', {
                                    id: event.target.result.value["id"],
                                    name: event.target.result.value["name"],
                                    description: event.target.result.value["description"]
                                });
                                event.target.result['continue']();
                            }
                        };
                    }

                };
            },
            openMapDialog: function () {
                this.$.mapDialog.open();
            },
            openInsertShopDialog: function () {
                this.action = "addShop";
                this.$.insertShopDialog.open();
            },
            openUpdateShopDialog: function (e) {
                this.action = "update";
                var item = this.$.shopList.itemForElement(e.target);
                this.nameShop = item.name;
                this.descriptionShop = item.description;
                this.longitude = item.longitude;
                this.latitude = item.latitude;
                this.iconShop = item.icon;
                this.idShop = item.id;
                this.$.insertShopDialog.open();
            },
            doAction: function () {
                if (this.action == "update") {
                    this.update();
                } else {
                    this.addShop();
                }
            }
        })
    </script>
</dom-module>